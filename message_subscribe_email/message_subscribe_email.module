<?php
/**
 * @file
 * Code for the  message subscribe email feature.
 */

/**
 * Implements hook_flag_access().
 *
 * @todo Flag access is broken. See https://www.drupal.org/node/2584647.
 */
function message_subscribe_email_flag_access($flag, $content_id, $action, $account) {
  if (strpos($flag->name, 'email_') === 0) {

    $entity_type = FLAG_API_VERSION == 3 ? $flag->entity_type : $flag->content_type;

    // Get the other flags on that same content.
    $user_flags = flag_get_user_flags($entity_type, $content_id, $account->uid);

    $name = str_replace('email_', '', $flag->name);
    // @FIXME
// // @FIXME
// // This looks like another module's variable. You'll need to rewrite this call
// // to ensure that it uses the correct configuration object.
// $prefix = variable_get('flag_prefix', 'subscribe') . '_';

    // Disable access to the flag when the subscribe flag is unflagged, but
    // allow unflagging.
    return $action == 'unflag' || !empty($user_flags[$prefix . $name]);
  }
}

/**
 * Get Email subscribe related flags ids.
 *
 * Return Flag ids realted to email subscriptions.
 *
 * The flag name should start with "email_".
 *
 * @param $content_type
 *   Optional. The type of content for which to load the flags. Usually 'node'.
 * @param $content_subtype
 *   Optional. The node type for which to load the flags.
 * @param $account
 *   Optional. The user accont to filter available flags. If not set, all
 *   flags for will this node will be returned.
 *
 * @return $flags
 *   An array of the structure [fid] = flag_object.
 *
 * @todo convert this to a service/manager class.
 */
function message_subscribe_email_flag_get_flags($content_type = NULL, $content_subtype = NULL, $account = NULL) {
  $flags = \Drupal::service('flag')->getFlags($content_type, $content_subtype, $account);
  $email_flags = array();
  foreach ($flags as $flag_name => $flag) {
    // Check that the flag is using name convention.
    if (strpos($flag_name, 'email') === 0) {
      $email_flags[$flag_name] = $flag;
    }
  }

  return $email_flags;
}

/**
 * Implements hook_message_subscribe_get_subscribers_alter().
 *
 * Filters out subscribes to show only email subscribers.
 */
function message_subscribe_email_message_subscribe_get_subscribers_alter(array &$uids, array $values) {
  if (empty($uids)) {
    // Nobody is subscribed to the content.
    return;
  }

  if (!$flags = message_subscribe_email_flag_get_flags()) {
    // No subscribe email related flags.
    return;
  }

  $flag_ids = array();
  foreach ($flags as $flag) {
    $flag_ids[] = $flag->id();
  }

  $query = db_select('flagging', 'f');
  $result = $query->fields('f', array('uid'))
    ->condition('flag_id', $flag_ids, 'IN')
    ->condition('uid', array_keys($uids), 'IN')
    ->groupBy('uid')
    ->execute()
    ->fetchAll();

  foreach ($result as $row) {
    // Add 'email' to the list of notifiers.
    $uids[$row->uid]['notifiers']['email'] = 'email';
  }
}
