<?php

/**
 * @file
 * Test for the Message subscribe email module.
 */

/**
 * @file
 * Test integration for the message_subscribe_email module.
 */

abstract class MessageSubscribeEmailTestHelper extends DrupalWebTestCase {

  /**
   * @var
   *
   * User1 object.
   */
  protected $user1;

  /**
   * @var
   *
   * User2 object.
   */
  protected $user2;

  /**
   * @var
   *
   * The node object for the tests.
   */
  protected $node;


  function setUp() {
    parent::setUp('message_subscribe', 'flag', 'message_subscribe_email', 'og');

    // Create node-type.
    $node_type = $this->drupalCreateContentType();
    $node_type = $node_type->type;

    // Enable flags.
    $flags = flag_get_default_flags(TRUE);

    $flag = $flags['subscribe_node'];
    $flag->types[] = $node_type;
    $flag->save();
    $flag->enable();

    $flag = $flags['email_node'];
    $flag->types[] = $node_type;
    $flag->save();
    $flag->enable();

    // Reset our cache so our permissions show up.
    drupal_static_reset('flag_get_flags');

    // Reset permissions so that permissions for this flag are available.
    $this->checkPermissions(array(), TRUE);

    $permissions = array(
      'flag subscribe_node',
      'unflag subscribe_node',
      'flag email_node',
      'unflag email_node',
    );

    $user1 = $this->drupalCreateUser($permissions);
    $user2 = $this->drupalCreateUser($permissions);

    // Create node.
    $settings = array();
    $settings['type'] = $node_type;
    $settings['uid'] = $user1->uid;
    $node = $this->drupalCreateNode($settings);

    // Create a dummy message-type.
    $message_type = message_type_create('foo');
    $message_type->save();

    $this->node = $node;
    $this->user1 = $user1;
    $this->user2 = $user2;
  }
}

/**
 * Test getting email subscribes from context.
 */
class MessageSubscribeEmailSubscribersTest extends MessageSubscribeEmailTestHelper {

  public static function getInfo() {
    return array(
      'name' => 'Get email subscribers',
      'description' => 'Get email subscribers from content.',
      'group' => 'Message subscribe',
    );
  }

  function setUp() {
    parent::setUp();

    // Opt out of default email notifications.
    $wrapper = entity_metadata_wrapper('user', $this->user1);
    $wrapper->message_subscribe_email->set(FALSE);
    $wrapper = entity_metadata_wrapper('user', $this->user2);
    $wrapper->message_subscribe_email->set(FALSE);

    flag('flag', 'subscribe_node', $this->node->nid, $this->user1);
    flag('flag', 'subscribe_node', $this->node->nid, $this->user2);

    flag('flag', 'email_node', $this->node->nid, $this->user1);

    // Override default notifiers.
    variable_set('message_subscribe_default_notifiers', array());
  }

  /**
   * Test getting the subscribers list.
   */
  function testGetSubscribers() {
    // Make sure we are notifying ourselves for this test.
    variable_set('message_subscribe_notify_own_actions', TRUE);

    $message = message_create('foo');

    $node = $this->node;
    $user1 = $this->user1;
    $user2 = $this->user2;

    $uids = message_subscribe_get_subscribers('node', $node, $message);

    // Assert subscribers data.
    $expected_uids = array(
      $user1->uid => array(
        'notifiers' => array(
          'email' => 'email',
        ),
        'flags' => array(
          'subscribe_node',
        ),
      ),
      $user2->uid => array(
        'notifiers' => array(),
        'flags' => array(
          'subscribe_node',
        ),
      ),
    );

    $this->assertEqual($uids, $expected_uids, 'All expected subscribers were fetched.');

    $subscribe_options = array(
      'uids' => $uids,
    );
    message_subscribe_send_message('node', $node, $message, array(), $subscribe_options);

    // Assert sent emails.
    $email_count = count(variable_get('drupal_test_email_collector', array()));
    $this->assertEqual($email_count, 1, 'Only one user was sent an email.');
  }
}

/**
 * Test automatic email notification flagging.
 */
class MessageSubscribeEmailNotificationsTest extends MessageSubscribeEmailTestHelper {

  public static function getInfo() {
    return array(
      'name' => 'Check email notifications',
      'description' => 'Check automatic email notifications for content.',
      'group' => 'Message subscribe',
    );
  }

  function setUp() {
    parent::setUp();

    flag('flag', 'subscribe_node', $this->node->nid, $this->user1);

    // Override default notifiers.
    variable_set('message_subscribe_default_notifiers', array());
  }

  /**
   * Test opting in/out of default email notifications.
   */
  function testEmailNotifications() {
    // Make sure we are notifying ourselves for this test.
    variable_set('message_subscribe_notify_own_actions', TRUE);

    $message = message_create('foo');

    $node = $this->node;
    $user1 = $this->user1;

    $uids = message_subscribe_get_subscribers('node', $node, $message);

    // Assert subscribers data.
    $expected_uids = array(
      $user1->uid => array(
        'notifiers' => array(
          'email' => 'email',
        ),
        'flags' => array(
          'subscribe_node',
        ),
      ),
    );

    $this->assertEqual($uids, $expected_uids, 'All expected subscribers were fetched.');

    flag('unflag', 'subscribe_node', $node->nid, $user1);

    // Opt out of default email notifications.
    $wrapper = entity_metadata_wrapper('user', $user1);
    $wrapper->message_subscribe_email->set(FALSE);

    flag('flag', 'subscribe_node', $node->nid, $user1);

    $uids = message_subscribe_get_subscribers('node', $node, $message);

    // Assert subscribers data.
    $expected_uids = array(
      $user1->uid => array(
        'notifiers' => array(),
        'flags' => array(
          'subscribe_node',
        ),
      ),
    );

    $this->assertEqual($uids, $expected_uids, 'All expected subscribers were fetched.');
  }
}

/**
 * Check the toggle button for sending email for subscribe groups.
 */
class MessageSubscribeSendMailButtonTest extends MessageSubscribeEmailTestHelper {

  /**
   * @var
   *
   * The group object.
   */
  protected $group;

  public static function getInfo() {
    return array(
      'name' => 'Check email notifications send toggle',
      'description' => 'Check email notifications when the user disable the notification.',
      'group' => 'Message subscribe',
    );
  }

  public function setUp() {
    parent::setUp();

    // Set up group.
    $group_type = $this->drupalCreateContentType(array('type' => 'group'));
    og_create_field(OG_GROUP_FIELD, 'node', 'group');
    $this->group = $this->drupalCreateNode(array('type' => $group_type->type));

    // Set up groups content type.
    og_create_field(OG_AUDIENCE_FIELD, 'node', $this->node->type);

    og_group('node', $this->group, array('entity_type' => 'user', 'entity' => $this->user1));
    og_group('node', $this->group, array('entity_type' => 'user', 'entity' => $this->user2));

    // Grant groups permission to users.
    $rid = og_get_user_roles('node', $this->group->nid, $this->user1->uid);

    og_role_grant_permissions(key($rid), array(
      "create {$this->node->type} content"
    ));

    $flags = flag_get_default_flags(TRUE);
    $flag = $flags['subscribe_og'];
    $flag->types[] = $this->group->type;
    $flag->save();
    $flag->enable();
    drupal_static_reset('flag_get_flags');
  }

  /**
   * Testing the email sending workflow when flagging and un flagging OG flag.
   */
  public function testDontSendMailButton() {
    // Flag a group for both users.
    $flag = flag_get_flag('subscribe_og');
    $flag->flag('flag', $this->group->nid, $this->user1, TRUE);
    $flag->flag('flag', $this->group->nid, $this->user2, TRUE);

    // Post a group content by user1 and verify user2 received the mail.
    $node = $this->drupalCreateNode(array(
      'type' => $this->node->type,
    ));

    // Post a group content by user2 and verify user1 received the mail.
    og_group('node', $this->group, array('entity_type' => 'node', 'entity' => $node));

    $message = message_create('foo');
    $uids = message_subscribe_get_subscribers('node', $this->group, $message);
    $this->assertEqual(array_keys($uids), array($this->user1->uid, $this->user2->uid), 'User 1 and user 2 receiving the messages.');

    // user2 disable mails from group1.
    $flag->flag('unflag', $this->group->nid, $this->user2, TRUE);

    // Post a group content by user1 and verify user2 did not received the mail.
    $uids = message_subscribe_get_subscribers('node', $this->group, $message);
    $this->assertEqual(array_keys($uids), array($this->user1->uid), 'Only user 1 will receive mails about relate to the group.');
  }

}
